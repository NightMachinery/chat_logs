[01:34:22] <MattWelke[m]> Read https://twitter.com/y8/status/1471469839453724674?s=20 today and it made me think of JRuby. I have my own policy of sponsoring open source to keep things sustainable for me where I give $5/mo if I've deployed code that users it, and $1/mo if I'm just interested in a project.
[01:34:22] <MattWelke[m]> That means I'd give $1/mo to JRuby right now (with the idea being if others did too, it would be sustainable for them and it would end up being a lot of funding for JRuby).
[01:34:22] <MattWelke[m]> Does the project have sponsorship set up on something like GitHub Sponsors or Open Collective?
[01:53:29] <headius> Matt Welke: yeah contributions would be appreciated, especially for resources we can purchase like cloud time or development systems and tools. I've also thought about bug bounties but I feel like that's a dangerous line to cross
[01:54:13] <headius> The biggest thing that would help would be getting JRuby users to contribute 10% or 20% of their work hours each week to helping us
[01:54:21] <headius> I'm not sure how to convince companies to do that
[01:55:22] <MattWelke[m]> Yeah this is a tricky problem to solve. I first thought about approaching my company about sponsoring the open source we use years ago, but it seemed like no one was doing it so I felt awkward trying to bring it up. Log4Shell has brought it back on my mind.
[01:55:43] <MattWelke[m]> While I figure out what to do about corporate sponsorships at my company, I can at least act on my personal policy for personal sponsorships.
[01:55:59] <headius> We are clearly very lucky to have been sponsored for so many years but the project is bigger than two full-time people
[01:56:15] <MattWelke[m]> Let me know when JRuby has sponsorships set up. You've got one from me once it's running.
[02:12:06] <headius> Sure I'll set it up and confer with enebo and then get back to you
[10:35:17] *** Quits: satyanash (~satyanash@143.110.247.92) (Quit: kthnxbai)
[10:35:31] *** Joins: satyanash (~satyanash@143.110.247.92)
[11:55:01] *** Quits: drbobbeaty (~drbob@c-24-14-127-107.hsd1.il.comcast.net) (Ping timeout: 250 seconds)
[11:56:09] *** Joins: drbobbeaty (~drbob@c-24-14-127-107.hsd1.il.comcast.net)
[12:07:13] *** Quits: drbobbeaty (~drbob@c-24-14-127-107.hsd1.il.comcast.net) (Ping timeout: 256 seconds)
[12:08:10] *** Joins: drbobbeaty (~drbob@c-24-14-127-107.hsd1.il.comcast.net)
[12:30:09] *** Quits: boc_tothefuture[ (~boctothef@2001:470:69fc:105::1:3558) (Quit: You have been kicked for being idle)
[12:30:09] *** Quits: akshsingh[m] (~akshsingh@2001:470:69fc:105::1:3519) (Quit: You have been kicked for being idle)
[14:04:43] <mattpatt[m]> Sorry about https://github.com/jruby/jruby/issues/6974. Will try and dig in around filesystem security / permissions stuff so I can help with that...
[14:06:59] <headius> You should try a snapshot build of 9.3.3, I found a bug in our native stat that could cause this
[14:07:37] <headius> https://github.com/jnr/jnr-posix/pull/173
[14:08:25] <headius> mattpatt: 
[14:08:51] <mattpatt[m]> headius: sweet
[14:09:16] <headius> Ugh the snapshots aren't back yet because we just did a big migrate to GHA
[14:09:23] <headius> I will run one myself
[14:09:34] <mattpatt[m]> Since I have an M1 mac, if you need stuff testing, you're welcome to ask me...
[14:09:42] <mattpatt[m]> i remember that GHA transition ;-)
[14:09:55] <headius> Oh hah of course you do
[14:10:02] <headius> I forgot we didn't have snapshots working quite yet
[14:10:16] <mattpatt[m]> Want me to work on getting snapshots working again?
[14:10:32] <mattpatt[m]> doing a bunch of GHA stuff for work today anyway
[14:12:11] <headius> Yeah I haven't even looked at why they aren't working
[14:12:24] <headius> I probably missed some step
[14:12:36] <mattpatt[m]> I don't think i even tried during the migration
[14:13:01] <mattpatt[m]> wasn't sure when they should run
[14:14:42] <headius> we actually just push them on every successful CI
[14:16:23] <mattpatt[m]> i remember now. there's a manual task you can trigger, so we can debug it.
[14:16:41] <headius> aha that's right
[14:16:46] <mattpatt[m]> once that's working okay it's just a case of adding a ref to the reusable task in the main workflow
[14:16:54] <mattpatt[m]> i need more coffee
[14:17:26] <headius> https://github.com/jruby/jruby/actions/runs/1591835682
[14:17:47] <headius> snapshots from my local build should be there
[14:17:53] <mattpatt[m]> thanks
[14:18:15] <headius> there's still problems with varargs, which prevents fcntl among other things from working right
[14:18:19] <headius> chrismtas project
[14:18:27] <headius> eh
[14:18:35] <mattpatt[m]> speaking of which, i need to run and silkscreen print some shit
[14:21:30] <mattpatt[m]> hang on, if that manual process works then I will submit a PR with it enabled for every successful CI
[14:22:08] <headius> yeah successful CI only on jruby-9.3 and master branches
[14:22:31] <headius> seems to be having trouble provisioning
[14:26:29] <headius> unauthorized
[14:26:29] <mattpatt[m]> provisioned then gfa
[14:26:31] <mattpatt[m]> failed
[14:26:41] <mattpatt[m]> looks like credentials not set?
[14:26:43] <headius> secrets missing probably
[14:26:46] <headius> yeah
[14:29:46] <mattpatt[m]> in case you don't know there's a secrets pane in the repo settings for GHA secrets and ENV vars
[14:30:19] <headius> yeah took a minute but I'm there
[14:30:29] <mattpatt[m]> took me a while to find it first time for me too
[14:39:32] <mattpatt[m]> lemme poke at that workflow and see if i made a silly
[14:40:04] <headius> trying to remember out how these get propagated into the deploy target
[14:40:16] <headius> some of these variables being set in the workflow appear nowhere else in the repo
[14:40:29] <mattpatt[m]> i have a feeling it's a dumb workflow syntax thing
[14:40:58] <headius> also unsure if my secrets are being used right... I set the environment "deploy" up to be active for master and jruby-9.3 branches
[14:41:42] <mattpatt[m]> https://github.com/actions/setup-java/blob/main/docs/advanced-usage.md#Publishing-using-Apache-Maven
[14:43:28] <headius> yeah I don't get why the intermediate env vars when you can just put the secrets in the setup-java part
[14:43:31] <mattpatt[m]> where does the maven settings.xml get generated?
[14:44:43] <mattpatt[m]> right. do not have enough coffee in system for this, will circle back to it later on
[14:45:31] <mattpatt[m]> sorry, i don't have any experience doing maven deploys, so my mental model for what's going on is non existent and i have no intuition for what might be the problem...
[14:46:03] <mattpatt[m]> best i have so far is that maybe GHA is generating a maven settings.xml and so is something else?
[14:46:20] <mattpatt[m]> i have a vague recollection of that being how GHA maven deploy works
[14:47:31] <headius> I think I got it
[14:47:51] <mattpatt[m]> Is this line wrong?           server-id: sonatype-nexus-snapshots
[14:47:53] <headius> I did not notice the "New Repository Secret" button so I added them to an environment, which must not have been activating right
[14:48:00] <mattpatt[m]> https://github.com/jruby/jruby/blob/dd5296e23970100cd9234e95fc58578ce1ce1d8b/.github/workflows/snapshot-publish.yml#L24
[14:48:19] <mattpatt[m]> pom.rb has id as plain 'sonatype'
[14:48:36] <headius> Why is the "New Repository Secret" button at the top of the page but the list of repository secrets is halfway down
[14:48:39] <headius> that's just dumb
[14:49:32] <headius> aha it needs to run with 8
[14:49:32] <headius> but otherwise it worked
[14:49:41] <mattpatt[m]> sweet
[14:51:18] <headius> so what's the last switch I need to throw
[14:55:13] <headius> not sure how to trigger this only after other actions succeed... seems like docs only show how to have it in the same workflow as whatever you want to trigger from
[15:04:04] <headius> a recent post points this out as the best way currently: https://github.com/marketplace/actions/wait-on-check
[15:04:32] <headius> but it depends on a workflow step that waits for another workflow to finish, and if we have a step waiting for the 20-30min we need it will probably get killed
[15:05:29] <headius> it might be simplest to move this to the main workflow or create a deploy workflow that runs a smaller set of sanity checks
[15:05:46] <headius> let me know if you have another idea when you've got your coffee ☕️
[16:26:46] <mattpatt[m]> oh, it's simple
[16:27:17] <mattpatt[m]> it's a reusable workflow, so we just reuse it in the CI with a dependency on whatever passing we need
[16:27:35] <mattpatt[m]> will send you a PR later]
[16:28:28] <mattpatt[m]> well, it's straightforward anyway
[16:28:44] <mattpatt[m]> maybe not totally simple. the dependency stuff is a bit verbose
[16:39:59] <headius> yeah cool
[16:40:15] <headius> I am playing with some speedups like caching maven stuff better and will PR this branch when I'm happy with it
[16:40:37] <headius> I think we can also cache the compiled base sources which should cut a minute or so off every job
[17:42:36] <headius> wow ok uploading the build output is way slower than just rebuilding for each job
[17:52:06] <headius> uploading core/target after a clean package took 4.5 minutes... I assume downloading would cost the same so that's way slower than rebuilding
[18:51:30] <enebo[m]> byteit101: https://github.com/jruby/jruby/issues/6967#issuecomment-996802612
[18:52:37] <enebo[m]> This reported issue is interesting to me in that it is doing arity checking which made me wonder how we behave if that raise line is missing.  It really feels like if we had reasonable error messages someone would not put that there.
[18:53:13] <enebo[m]> But the second thing I wanted was some agreement that what I wrote in that comment is reasonable.  I believe raise requires this.
[18:58:31] <headius> mattpatt: I get it now... you use `needs` and call the snapshot-publish workflow at the end of the main workflow
[19:06:13] <headius> I pushed a larger change just now that massively reduces duplication in the CI workflow but unsure if it is the best approach: https://github.com/jruby/jruby/commit/0029dd29dfe8336778517a9b44b1cf7b6cc51881
[19:06:36] <headius> leaning on matrices for as many permutations as possible
[19:06:54] <headius> my generic target names are not great though
[19:07:19] <headius> https://github.com/jruby/jruby/actions/runs/1592915297
[19:07:42] <headius> this added a handful of additional jobs but mostly just moved hand-duplicated jobs into matrices
[19:09:01] <enebo[m]> ok I was thinking it looked like more jobs being run
[19:09:50] <enebo[m]> heh it already found some strictness error with Java 16 
[19:09:52] <headius> enebo: the added jobs were mostly adding 16 where we already did 8 and 11
[19:10:01] <headius> yeah it sure did
[19:10:11] <headius> that seems to be the only thing new breaking though
[19:10:28] <enebo[m]> yeah I guess that's good
[19:10:54] <enebo[m]> I removed a test from one of our suites yesterday that is covered to death by mri/mspec
[19:11:07] <headius> excellent
[19:11:11] <headius> we have a lot of those
[19:11:23] <enebo[m]> I realize we cannot remove all of our tests but I am thinking we should occasionally just pare down our tests 
[19:11:42] <headius> whenever I notice a dupe I will wipe it out
[19:11:56] <headius> or if MRI fails a test we have I just delete it
[19:11:56] <enebo[m]> I almost updated them but it was comparing the new Method inspect strings and I was "nope" :)
[19:12:19] <enebo[m]> Today is sprintf friday
[19:12:54] <enebo[m]> It is a significant feature for 9.4 but I am boiling a small ocean
[19:13:27] <headius> have fun
[19:14:20] <enebo[m]> here was some fun from yesterday:
[19:14:49] <enebo[m]> d[5][1][1][1][1][1][1][1][1][1][1][1][1][1][1][1][1][1][1][1][1][1]... (full message at https://libera.ems.host/_matrix/media/r0/download/libera.chat/beefef8098b2fe303b6001c440ab0e96197ebe8a)
[19:15:21] <enebo[m]> I fixed some recursive flatten issue
[19:16:09] <enebo[m]> I did other fixes too but this one was weird.  It did not occur to me flattening a recursive array will partially flatten it but leave the recursion behind
[19:16:51] <enebo[m]> It is when I work on bug fixes for stuff like this I am entertained at how strange Ruby can be (and tbh this behavior does make sense)
[19:19:10] *** Joins: subbu (~subbu@user/subbu)
[19:26:26] <headius> yeah I suppose it does
[19:26:48] <headius> ok I cleaned up the failures and simplified the aggregate job names so you can see the matrix elements easier
[19:26:50] <headius> https://github.com/jruby/jruby/actions/runs/1593010522
[19:27:30] <headius> the names are not as descriptive but I don't think that can be avoided
[19:27:59] <headius> hmm maybe there is a better way to specify a matrix-generated display name
[20:03:27] <headius> ok I think I've got it
[20:03:28] <headius> https://github.com/jruby/jruby/actions/runs/1593145610
[20:03:43] <headius> that looks decent and the workflow file is much smaller now
[20:04:14] <headius> we can endeavor to merge those one-off jobs into the aggregate once
[20:04:20] <headius> ones
[20:05:10] <headius> hmm one more bit of smithing... I think we want these to sort by target first, java version second
[20:05:15] <headius> hopefully flipping the matrix will do that
[20:09:50] <headius> yeah that looks nicer
[20:10:13] <headius> after I merge this we can reorder jobs or whatever seems to make it easier to read through
[20:10:44] <headius> some of these may not need to run on all javas so we could pare them down
[20:16:49] <headius> prior to this work it was 51 jobs, now it is 58
[20:18:13] <headius> oh one of those new ones is the Windows job
[20:18:43] <headius> ffi gained java 16
[20:24:42] <headius> oh I see... enebo there are more jobs but some of these were just run sequentially in the same job before
[20:25:04] <headius> moving them into matrices added jobs but allows them to run in parallel
[20:25:42] <headius> we can also consider batching some of those back together, like those fast little maven targets
[20:26:21] <headius> so I know windows job was moved over and FFI gained a 16 job but there's not much else that wasn't already running somewhere
[20:36:25] <headius> https://github.com/jruby/jruby/pull/6975
[21:00:54] <enebo[m]> ship it!
[21:01:38] <enebo[m]> GHA really needs to show times in the left hand side summary
[21:28:05] <headius> Yeah that would be nice
[21:33:24] <headius> the mvn targets are usually the fastest runs, they should probably move down so the longer rake tasks get queued earlier
[21:33:32] <headius> I'm going to try to reenable the snapshot build
[23:17:41] <byteit101[m]> enebo: oh those 3 issues are fun. I don't think I tested re-opened classes. Will look at it more after work. Though I am glad I changed the error to `Java proxy not initialized. Did you call super() yet?` from a generic NPE
[23:18:08] <enebo[m]> byteit101: yeah it is helpful as a message
